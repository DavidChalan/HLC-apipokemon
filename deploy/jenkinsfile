pipeline {
    agent any
    environment {
        K8S_SERVER = "https://192.168.49.2:8443"
        NAMESPACE = "default"
    }
    stages {
        stage('Clonar repositorio git Pokeapi desde Github') {
            steps {
                git branch: 'main', url: 'https://github.com/DavidChalan/HLC-apipokemon.git'
            }
        }
        stage('Configurar acceso a Kubernetes') {
    steps {
        withCredentials([string(credentialsId: 'k8s-token', variable: 'K8S_TOKEN')]) {
            sh """
            kubectl config set-cluster k8s-cluster --server=$K8S_SERVER --insecure-skip-tls-verify=true
            kubectl config set-credentials jenkins --token=${env.K8S_TOKEN}
            kubectl config set-context jenkins --cluster=k8s-cluster --user=jenkins --namespace=$NAMESPACE
            kubectl config use-context jenkins
            """
        }
    }
}

        stage('Verificar conexión con Kubernetes') {
            steps {
                script {
                    sh """
                    kubectl config current-context
                    kubectl cluster-info
                    """
                }
            }
        }
        stage('Verificar kubectl 1') {
            steps {
                sh 'kubectl version --client'
                sh 'kubectl get nodes' // Confirma conexión con el clúster
            }
        }
        stage('Deploy en Kubernetes') {
            steps {
                script {
                    sh "kubectl apply -f deploy/kubernetes/deploy.yaml"
                    sh "kubectl apply -f deploy/kubernetes/serviceNP.yaml"
                }
            }
        }
    }
    post {
        success {
            echo "Despliegue completado con éxito"
        }
        failure {
            echo "Error en el despliegue"
        }
    }
}
